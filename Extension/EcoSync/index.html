<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Eco-Sync Extension UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap");
      /* Base styles */
      body {
        background-color: #f3f4f6; /* Tailwind bg-gray-100 */
        font-family: "Inter", sans-serif;
      }

      /* Modal container */
      #eco-sync-modal {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        width: 350px;
        max-width: 90vw;
        display: none; /* Tailwind's hidden */
      }

      /* Modal box */
      #eco-sync-modal > div {
        background-color: #d1fae5; /* Tailwind bg-green-100 */
        border-radius: 1rem; /* Tailwind rounded-2xl */
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Tailwind shadow-lg */
        border: 2px solid #22c55e; /* Tailwind border-green-500 */
        overflow: hidden;
        transform: scale(1);
        transition: transform 0.3s;
        padding: 1rem; /* Tailwind p-4 */
      }

      /* Header section */
      #eco-sync-modal .flex {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem; /* Tailwind mb-2 */
      }

      /* Title */
      #eco-sync-modal h3 {
        font-size: 1.125rem; /* Tailwind text-lg */
        font-weight: bold;
        color: #065f46; /* Tailwind text-green-800 */
        display: flex;
        align-items: center;
      }

      /* Leaf icon spacing */
      #eco-sync-modal h3 i {
        font-size: 1.25rem; /* Tailwind text-xl */
        margin-right: 0.5rem; /* Tailwind mr-2 */
      }

      /* Close button */
      #eco-sync-modal #close-modal {
        color: #15803d; /* Tailwind text-green-700 */
        transition: color 0.2s ease-in-out;
        background: none;
        border: none;
        cursor: pointer;
      }

      #eco-sync-modal #close-modal:hover {
        color: #14532d; /* Tailwind hover:text-green-900 */
      }

      /* Loading indicator */
      #eco-sync-modal #loading-indicator {
        font-size: 0.875rem; /* Tailwind text-sm */
        color: #15803d; /* Tailwind text-green-700 */
        font-style: italic;
      }

      #eco-sync-modal #loading-indicator i {
        margin-right: 0.5rem; /* Tailwind mr-2 */
      }

      /* Alternatives list */
      #eco-sync-modal #alternatives-list {
        margin-top: 1rem; /* Tailwind mt-4 */
      }

      #eco-sync-modal #alternatives-list > *:not(:last-child) {
        margin-bottom: 0.75rem; /* Tailwind space-y-3 */
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <!-- This is the HTML that the extension will inject into the Amazon page -->
    <div id="eco-sync-modal" class="hidden">
      <div
        class="bg-green-100 rounded-2xl shadow-lg border-2 border-green-500 overflow-hidden transform transition-transform duration-300 scale-100 p-4"
      >
        <div class="flex justify-between items-center mb-2">
          <h3 class="text-lg font-bold text-green-800 flex items-center">
            <i class="fas fa-leaf text-xl mr-2"></i>
            Sustainable Alternatives
          </h3>
          <button
            id="close-modal"
            class="text-green-700 hover:text-green-900 transition-colors"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div id="loading-indicator" class="text-sm text-green-700 italic">
          <i class="fas fa-spinner fa-spin mr-2"></i>
          Analyzing product and finding alternatives...
        </div>
        <div id="alternatives-list" class="mt-4 space-y-3">
          <!-- Alternatives will be injected here by the script -->
        </div>
      </div>
    </div>

    <script>
      // Use a self-invoking function to avoid global scope pollution
      (async () => {
        // Function to handle the generative AI call
        const fetchAlternatives = async (productTitle) => {
          const prompt = `Based on the product title "${productTitle}", please suggest 3-4 organic, eco-friendly, or sustainable alternatives. For each suggestion, provide a brief one-sentence description of why it's a better choice. Format the response as a simple JSON object like this:
                {"alternatives": [{"name": "Alternative 1", "description": "Why it's better."}, {"name": "Alternative 2", "description": "Why it's better."}]}`;

          let chatHistory = [];
          chatHistory.push({ role: "user", parts: [{ text: prompt }] });

          const payload = {
            contents: chatHistory,
            generationConfig: {
              responseMimeType: "application/json",
              responseSchema: {
                type: "OBJECT",
                properties: {
                  alternatives: {
                    type: "ARRAY",
                    items: {
                      type: "OBJECT",
                      properties: {
                        name: { type: "STRING" },
                        description: { type: "STRING" },
                      },
                    },
                  },
                },
              },
            },
          };

          // The API key is automatically provided by the Canvas environment.
          const apiKey = "AIzaSyDtuR06OSccodY-B6uyUlD1iUHiy8OCzZA";
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

          const maxRetries = 5;
          let retryDelay = 1000; // 1 second
          for (let i = 0; i < maxRetries; i++) {
            try {
              const response = await fetch(apiUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              });

              if (response.status === 429) {
                // Too many requests, wait with exponential backoff
                await new Promise((resolve) => setTimeout(resolve, retryDelay));
                retryDelay *= 2;
                continue;
              }

              if (!response.ok) {
                throw new Error(
                  `API call failed with status: ${response.status}`
                );
              }

              const result = await response.json();
              const jsonText = result.candidates[0].content.parts[0].text;
              return JSON.parse(jsonText).alternatives;
            } catch (error) {
              console.error("API call failed:", error);
              // Log errors for debugging but continue retrying
            }
          }
          return null; // Return null if all retries fail
        };

        const displayAlternatives = (alternatives) => {
          const listContainer = document.getElementById("alternatives-list");
          const loadingIndicator = document.getElementById("loading-indicator");
          listContainer.innerHTML = ""; // Clear previous results
          loadingIndicator.classList.add("hidden");

          if (!alternatives || alternatives.length === 0) {
            listContainer.innerHTML =
              '<p class="text-sm text-green-700">No alternatives found for this product.</p>';
            return;
          }

          alternatives.forEach((alt) => {
            const altDiv = document.createElement("div");
            altDiv.className = "bg-white p-3 rounded-xl shadow-inner";
            altDiv.innerHTML = `
                        <h4 class="font-semibold text-green-800">${alt.name}</h4>
                        <p class="text-sm text-gray-600 mt-1">${alt.description}</p>
                    `;
            listContainer.appendChild(altDiv);
          });
        };

        // Main function to run the extension logic
        const runExtension = async () => {
          // Ensure we are on a product page by checking the URL and a key element
          if (
            window.location.hostname.includes("amazon.com") &&
            document.getElementById("productTitle")
          ) {
            // Inject the modal HTML into the page's body
            const modalHtml =
              document.getElementById("eco-sync-modal").outerHTML;
            document.body.insertAdjacentHTML("beforeend", modalHtml);

            const modal = document.getElementById("eco-sync-modal");
            const closeModalButton = modal.querySelector("#close-modal");

            // Show the modal
            modal.classList.remove("hidden");

            closeModalButton.addEventListener("click", () => {
              modal.classList.add("hidden");
            });

            // Scrape the product title
            const productTitleElement = document.getElementById("productTitle");
            if (productTitleElement) {
              const productTitle = productTitleElement.innerText.trim();
              if (productTitle) {
                const alternatives = await fetchAlternatives(productTitle);
                displayAlternatives(alternatives);
              } else {
                displayAlternatives(null); // No title found
              }
            } else {
              displayAlternatives(null); // No product title element
            }
          }
        };

        // Wait for the window to load before running the script
        window.onload = runExtension;
      })();
    </script>
  </body>
</html>
